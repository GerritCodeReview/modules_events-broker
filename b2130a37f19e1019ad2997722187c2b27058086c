{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "bce6607b_c1091593",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 9,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-05-31T09:46:04Z",
      "side": 1,
      "message": "Perhaps this is misleading:\ninstanceId *might* be populated by the gerrit core, it is always optional.",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 59
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "55f8a33a_d479d14f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 9,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-05-31T10:19:40Z",
      "side": 1,
      "message": "Good point. But as a follow up change I want to add check for multi-site so for multi-site environment instanceId is mandatory",
      "parentUuid": "bce6607b_c1091593",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 59
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf90a1e0_65e925aa",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 9,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-05-31T10:34:46Z",
      "side": 1,
      "message": "but not for events-broker itself right?\nI know that at the moment events-broker is *only* used for multi-site, but I think it would be useful to explain the thinking behind this change (as you can see it still confuses me ðŸ˜Š).\n\nCould we explain that eventId might be null, that this code needs to still deal with both Event and EventMessage and why? perhaps a compatibility table in documentation would be good what do you think?",
      "parentUuid": "55f8a33a_d479d14f",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 59
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d853b2d2_ba579ef1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 9,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-04T01:44:50Z",
      "side": 1,
      "message": "\u003e but not for events-broker itself right?\n\u003e I know that at the moment events-broker is *only* used for multi-site, but I think it would be useful to explain the thinking behind this change (as you can see it still confuses me ðŸ˜Š).\n\u003e \n\u003e Could we explain that eventId might be null, that this code needs to still deal with both Event and EventMessage and why?\n\nWhy do we still to manage EventMessage in v3.4? We already did that in v3.3 to allow a smooth migration to v3.4.\n\n\u003e perhaps a compatibility table in documentation would be good what do you think?\n\nThat should be done in v3.3, but in v3.4 we can assume that instance-id is *mandatory*.\n\nEvents-broker should said *LOUD AND CLEAR* at startup that instance-id is mandatory and, if not injected, should fail the Gerrit startup.\n\nHow can event-broker say from which instance the event is coming from?",
      "parentUuid": "cf90a1e0_65e925aa",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 59
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "db14194f_3635613c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 9,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-06-04T05:12:12Z",
      "side": 1,
      "message": "But for rolling upgrade part of the nodes will be on stable-3.3 and they will send EventMessage events to stable-3.4 so both v3.3. and v3.4 must be able to handle both Event and EventMessage. We can get rid of EventMessage on master(v3.5)",
      "parentUuid": "d853b2d2_ba579ef1",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 59
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "de2879b4_83ec0edd",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 9,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-05T00:55:57Z",
      "side": 1,
      "message": "How should the cutover work?\n\nv3.3 \u003c\u003d (EventMessage) \u003d\u003e v3.3\nv3.3 \u003c\u003d (EventMessage) \u003d\u003e v3.4\nv3.4 \u003c\u003d (EventMessage) \u003d\u003e v3.4\n... but then how do we move from there?\n\nIf v3.5 won\u0027t support EventMessage anymore, how would it talk to v3.4?\nI believe we should need a compatibility mode in v3.4 that, once the rollout is done, should be switched off.",
      "parentUuid": "db14194f_3635613c",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 59
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ea57aa2a_7ff9f6e1",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 35,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-05-31T09:46:04Z",
      "side": 1,
      "message": "I am a bit confused by this,\nI thought this change was going to eliminate completely the need for EventMessage and that only Event is going to be published/consumed.",
      "range": {
        "startLine": 35,
        "startChar": 4,
        "endLine": 35,
        "endChar": 66
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "55f4d4ea_a5ad1fcd",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 35,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-05-31T10:19:40Z",
      "side": 1,
      "message": "On stable-3.4 we still need it for rolling upgrades. On stable-3.5 we will completely remove EventMessage but for now we have to keep backward compatibility.",
      "parentUuid": "ea57aa2a_7ff9f6e1",
      "range": {
        "startLine": 35,
        "startChar": 4,
        "endLine": 35,
        "endChar": 66
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "86969f43_46c23e3f",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 35,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-05-31T10:34:46Z",
      "side": 1,
      "message": "\u003e On stable-3.4 we still need it for rolling upgrades. On stable-3.5 we will completely remove EventMessage but for now we have to keep backward compatibility.\n\nI thought that we dealt with this duality on stable-3.3.\nBy reading the commit message:\n\n\"Workaround with EventMessage is not needed anymore.\"\n\nIs it actually the case this is still needed to deal with stable-3.3 messages?",
      "parentUuid": "55f4d4ea_a5ad1fcd",
      "range": {
        "startLine": 35,
        "startChar": 4,
        "endLine": 35,
        "endChar": 66
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "07f60900_d688ee08",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 35,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-04T01:44:50Z",
      "side": 1,
      "message": "+1 to @Tony\u0027s comment. We should get rid of it in v3.4",
      "parentUuid": "86969f43_46c23e3f",
      "range": {
        "startLine": 35,
        "startChar": 4,
        "endLine": 35,
        "endChar": 66
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a839511b_c47ea8b0",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 35,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-05T00:55:57Z",
      "side": 1,
      "message": "As we need to keep decoding messages from v3.3, we need to keep this for now.",
      "parentUuid": "07f60900_d688ee08",
      "range": {
        "startLine": 35,
        "startChar": 4,
        "endLine": 35,
        "endChar": 66
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "37161064_f6fee58f",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 37,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-05T00:55:57Z",
      "side": 1,
      "message": "Who is doing the validation in this case? What if the instanceId return is null?",
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "64a036b0_6ca57af3",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-05-31T09:46:04Z",
      "side": 1,
      "message": "I am trying to understand this bit.\n`event.instanceId` is populated by the @GerritInstanceId, this might be null.\n\n`event.header.sourceInstanceId` is populated by @InstanceId, the generated multi-site data, this is never null.\n\nSo if I get this right, we are saying: \"if the gerrit server that produced this message didn\u0027t have any serverId, backfill it with the source id of the multi-site node that produced the EventMessage\"\n\nAre we abusing the `event.instanceId` by populating it with multi-site data?\nWhat\u0027s the purpose of this? if Events can be generated by gerrit with an empty id, shouldn\u0027t we just cope with this when deserializing?",
      "range": {
        "startLine": 40,
        "startChar": 0,
        "endLine": 44,
        "endChar": 17
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "20158347_1033c4e6",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-05-31T10:19:40Z",
      "side": 1,
      "message": "Not entirely. We have to keep it backward compatible. So on stable-3.3 we can have old EventMessages without Event.instanceId populated but there is always EventMessage.header.sourceInstanceId.",
      "parentUuid": "64a036b0_6ca57af3",
      "range": {
        "startLine": 40,
        "startChar": 0,
        "endLine": 44,
        "endChar": 17
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "099fa186_0ddd768f",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-05-31T10:34:46Z",
      "side": 1,
      "message": "\u003e Not entirely. We have to keep it backward compatible. So on stable-3.3 we can have old EventMessages without Event.instanceId populated\n\nBut this is always the case right? it\u0027s not to do specifically with stable-3.3 messages. unless gerrit.instanceId is populated, the event.instanceId will always be null.\n\n but there is always EventMessage.header.sourceInstanceId.\n\nYep it is always defined, but I was trying to get my head around the fact that we should use it to \"backfill\" event.instanceId.",
      "parentUuid": "20158347_1033c4e6",
      "range": {
        "startLine": 40,
        "startChar": 0,
        "endLine": 44,
        "endChar": 17
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "02f40e42_b1b6d890",
        "filename": "src/main/java/com/gerritforge/gerrit/eventbroker/EventDeserializer.java",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-05T00:55:57Z",
      "side": 1,
      "message": "I believe this is the case where the message is coming from a v3.3, correct?\nIf yes, the instanceId *should* come from the header and not from the event, isn\u0027t it?",
      "parentUuid": "099fa186_0ddd768f",
      "range": {
        "startLine": 40,
        "startChar": 0,
        "endLine": 44,
        "endChar": 17
      },
      "revId": "b2130a37f19e1019ad2997722187c2b27058086c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}